<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GeminiFleet - AI Warehouse Robot Control</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', system-ui, sans-serif; background: #0a0e1a; color: #e0e0e0; height: 100vh; overflow: hidden; }

.app { display: grid; grid-template-columns: 1fr 380px; grid-template-rows: 48px 1fr; height: 100vh; }

/* Header */
.header { grid-column: 1 / -1; background: #111827; border-bottom: 1px solid #1e293b; display: flex; align-items: center; padding: 0 20px; gap: 12px; }
.header h1 { font-size: 18px; font-weight: 700; background: linear-gradient(135deg, #3b82f6, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; white-space: nowrap; }
.header .status { font-size: 12px; color: #64748b; }
.header .status .dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #22c55e; margin-right: 4px; animation: pulse 2s infinite; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
.header .stats { margin-left: auto; display: flex; gap: 16px; font-size: 12px; }
.header .stat-value { font-weight: 700; font-size: 15px; color: #f1f5f9; }
.header .stat-label { color: #64748b; font-size: 10px; }

/* Canvas area */
.canvas-area { position: relative; background: #0f1629; overflow: hidden; }
canvas { width: 100%; height: 100%; }

/* Sidebar — two-panel layout: top info (scrollable, shrinkable) + bottom chat (priority) */
.sidebar { background: #111827; border-left: 1px solid #1e293b; display: flex; flex-direction: column; overflow: hidden; }

.sidebar-info { overflow-y: auto; flex-shrink: 1; min-height: 0; }

.sidebar-section { padding: 10px 14px; border-bottom: 1px solid #1e293b; }
.sidebar-section h3 { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #64748b; margin-bottom: 8px; cursor: pointer; user-select: none; }
.sidebar-section h3:hover { color: #94a3b8; }
.sidebar-section h3::before { content: '\25BE '; font-size: 10px; }
.sidebar-section.collapsed h3::before { content: '\25B8 '; }
.sidebar-section.collapsed .section-content { display: none; }

/* Robot list */
.robot-list { display: flex; flex-direction: column; gap: 4px; }
.robot-card { background: #1e293b; border-radius: 6px; padding: 6px 10px; display: flex; align-items: center; gap: 8px; }
.robot-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.robot-name { font-size: 12px; font-weight: 600; flex: 1; }
.robot-state { font-size: 10px; padding: 2px 6px; border-radius: 10px; background: #374151; }
.robot-state.idle { color: #94a3b8; }
.robot-state.moving_to_pickup { background: #1e3a5f; color: #60a5fa; }
.robot-state.moving_to_dropoff { background: #14532d; color: #4ade80; }
.robot-state.waiting { background: #713f12; color: #fbbf24; }
.robot-deliveries { font-size: 11px; color: #94a3b8; min-width: 16px; text-align: right; }

/* Policy display */
.policy-grid { display: flex; flex-wrap: wrap; gap: 4px; }
.policy-item { font-size: 11px; background: #1e293b; padding: 3px 6px; border-radius: 4px; }
.policy-item .key { color: #64748b; }
.policy-item .val { color: #e2e8f0; font-weight: 600; }

/* Responsive */
@media (max-width: 900px) {
  .app { grid-template-columns: 1fr; grid-template-rows: 48px 40vh 1fr; }
  .sidebar { border-left: none; border-top: 1px solid #1e293b; }
}
@media (max-height: 700px) {
  .sidebar-info { max-height: 30vh; }
}

/* Chat */
.chat-area { flex: 1; display: flex; flex-direction: column; min-height: 0; }
.chat-messages { flex: 1; overflow-y: auto; padding: 12px 16px; display: flex; flex-direction: column; gap: 8px; }
.chat-msg { max-width: 95%; padding: 8px 12px; border-radius: 12px; font-size: 13px; line-height: 1.4; }
.chat-msg.user { background: #1d4ed8; align-self: flex-end; border-bottom-right-radius: 4px; }
.chat-msg.assistant { background: #1e293b; align-self: flex-start; border-bottom-left-radius: 4px; }
.chat-msg .changes { margin-top: 6px; font-size: 11px; color: #94a3b8; }
.chat-input-row { display: flex; gap: 8px; padding: 12px 16px; border-top: 1px solid #1e293b; }
.chat-input-row input { flex: 1; background: #1e293b; border: 1px solid #374151; border-radius: 8px; padding: 10px 14px; color: #e2e8f0; font-size: 13px; outline: none; }
.chat-input-row input:focus { border-color: #3b82f6; }
.chat-input-row button { background: #3b82f6; color: white; border: none; border-radius: 8px; padding: 10px 16px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; }
.chat-input-row button:hover { background: #2563eb; }
.chat-input-row button:disabled { background: #374151; cursor: not-allowed; }

/* API Key input */
.api-key-row { display: flex; gap: 8px; padding: 8px 16px; border-bottom: 1px solid #1e293b; }
.api-key-row input { flex: 1; background: #1e293b; border: 1px solid #374151; border-radius: 6px; padding: 6px 10px; color: #e2e8f0; font-size: 12px; outline: none; }
.api-key-row label { font-size: 11px; color: #64748b; display: flex; align-items: center; white-space: nowrap; }

/* Legend */
.legend { display: flex; gap: 12px; flex-wrap: wrap; }
.legend-item { display: flex; align-items: center; gap: 4px; font-size: 11px; color: #94a3b8; }
.legend-color { width: 12px; height: 12px; border-radius: 3px; }

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
</style>
</head>
<body>
<div class="app">
  <!-- Header -->
  <div class="header">
    <h1>GeminiFleet</h1>
    <span class="status"><span class="dot" id="statusDot"></span><span id="statusText">Connecting...</span></span>
    <div class="stats">
      <div><div class="stat-value" id="statDeliveries">0</div><div class="stat-label">Deliveries</div></div>
      <div><div class="stat-value" id="statPending">0</div><div class="stat-label">Pending</div></div>
      <div><div class="stat-value" id="statCollisions">0</div><div class="stat-label">Avoided</div></div>
      <div><div class="stat-value" id="statSteps">0</div><div class="stat-label">Steps</div></div>
    </div>
  </div>

  <!-- Canvas -->
  <div class="canvas-area">
    <canvas id="simCanvas"></canvas>
  </div>

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-info">
      <div class="sidebar-section" onclick="this.classList.toggle('collapsed')">
        <h3>Robots</h3>
        <div class="section-content">
          <div class="robot-list" id="robotList"></div>
          <button id="addRobotBtn" onclick="event.stopPropagation(); addRobot()" style="margin-top:6px;width:100%;background:#1e3a5f;color:#60a5fa;border:1px solid #2563eb;border-radius:6px;padding:6px;font-size:12px;font-weight:600;cursor:pointer;">+ Add Robot</button>
        </div>
      </div>
      <div class="sidebar-section" onclick="this.classList.toggle('collapsed')">
        <h3>Policy</h3>
        <div class="section-content">
          <div class="policy-grid" id="policyGrid"></div>
        </div>
      </div>
      <div class="sidebar-section collapsed" onclick="this.classList.toggle('collapsed')">
        <h3>Legend</h3>
        <div class="section-content">
          <div class="legend">
            <div class="legend-item"><div class="legend-color" style="background:#3b82f6"></div>Pickup</div>
            <div class="legend-item"><div class="legend-color" style="background:#22c55e"></div>Dropoff</div>
            <div class="legend-item"><div class="legend-color" style="background:#78716c"></div>Shelf</div>
            <div class="legend-item"><div class="legend-color" style="background:#6366f1"></div>Wall</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Chat — always visible, takes remaining space -->
    <div class="chat-area">
      <div class="sidebar-section" style="padding-bottom:4px; flex-shrink:0">
        <h3 style="cursor:default">Gemini Fleet Control</h3>
      </div>
      <div class="api-key-row">
        <label>Code:</label>
        <input type="password" id="accessCode" placeholder="Access code..." />
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="chat-msg assistant">Welcome! Tell me how to manage the fleet. Try: "Make robots faster" or "Prioritize safety over speed"</div>
      </div>
      <div class="chat-input-row">
        <input type="text" id="chatInput" placeholder="e.g. Make robots more cautious..." />
        <button id="chatSend">Send</button>
      </div>
    </div>
  </div>
</div>

<script>
const ROBOT_COLORS = ['#eab308','#06b6d4','#ec4899','#f97316','#818cf8','#4ade80'];
const canvas = document.getElementById('simCanvas');
const ctx = canvas.getContext('2d');

let latestState = null;
let ws = null;
let animFrame = null;

// ── WebSocket ────────────────────────────────────────────────────────
function connectWS() {
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  ws = new WebSocket(`${proto}://${location.host}/ws`);
  ws.onopen = () => {
    document.getElementById('statusDot').style.background = '#22c55e';
    document.getElementById('statusText').textContent = 'Connected';
  };
  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    if (msg.type === 'state') latestState = msg.data;
    if (msg.type === 'policy_update') {
      addChatMessage('assistant', msg.data.explanation, msg.data.changes);
    }
  };
  ws.onclose = () => {
    document.getElementById('statusDot').style.background = '#ef4444';
    document.getElementById('statusText').textContent = 'Disconnected';
    setTimeout(connectWS, 2000);
  };
  ws.onerror = () => ws.close();
}

// Fallback: poll if WS fails
async function pollState() {
  try {
    const r = await fetch('/api/state');
    latestState = await r.json();
  } catch {}
}

// ── Canvas rendering ─────────────────────────────────────────────────
function resizeCanvas() {
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * devicePixelRatio;
  canvas.height = rect.height * devicePixelRatio;
  canvas.style.width = rect.width + 'px';
  canvas.style.height = rect.height + 'px';
}

function worldToScreen(wx, wy) {
  // Map world coords (-10..10, -7..7) to canvas (PyBullet warehouse)
  const pad = 40 * devicePixelRatio;
  const w = canvas.width - pad * 2;
  const h = canvas.height - pad * 2;
  const sx = pad + ((wx + 10) / 20) * w;
  const sy = pad + ((7 - wy) / 14) * h;  // flip Y
  return [sx, sy];
}

function drawGrid() {
  const dpr = devicePixelRatio;
  ctx.strokeStyle = '#1e293b';
  ctx.lineWidth = 0.5 * dpr;
  for (let x = -10; x <= 10; x += 1) {
    const [sx, sy1] = worldToScreen(x, 7);
    const [, sy2] = worldToScreen(x, -7);
    ctx.beginPath(); ctx.moveTo(sx, sy1); ctx.lineTo(sx, sy2); ctx.stroke();
  }
  for (let y = -7; y <= 7; y += 1) {
    const [sx1, sy] = worldToScreen(-10, y);
    const [sx2] = worldToScreen(10, y);
    ctx.beginPath(); ctx.moveTo(sx1, sy); ctx.lineTo(sx2, sy); ctx.stroke();
  }
}

function drawShelves() {
  ctx.fillStyle = '#44403c';
  for (let row = 0; row < 3; row++) {
    for (let col = 0; col < 4; col++) {
      const wx = -4 + col * 3;
      const wy = -3.5 + row * 3.5;
      const [sx, sy] = worldToScreen(wx - 0.6, wy + 0.25);
      const [sx2, sy2] = worldToScreen(wx + 0.6, wy - 0.25);
      ctx.fillRect(sx, sy, sx2 - sx, sy2 - sy);
    }
  }
}

function drawZones() {
  // Pickup zones (blue)
  const pickups = [[-8,-5],[-8,0],[-8,5],[-5,-5],[-5,5]];
  ctx.fillStyle = 'rgba(59,130,246,0.3)';
  ctx.strokeStyle = '#3b82f6';
  ctx.lineWidth = 2 * devicePixelRatio;
  for (const [wx, wy] of pickups) {
    const [sx, sy] = worldToScreen(wx - 0.4, wy + 0.4);
    const [sx2, sy2] = worldToScreen(wx + 0.4, wy - 0.4);
    ctx.fillRect(sx, sy, sx2 - sx, sy2 - sy);
    ctx.strokeRect(sx, sy, sx2 - sx, sy2 - sy);
  }
  // Dropoff zones (green)
  const dropoffs = [[8,-5],[8,-1.5],[8,1.5],[8,5]];
  ctx.fillStyle = 'rgba(34,197,94,0.3)';
  ctx.strokeStyle = '#22c55e';
  for (const [wx, wy] of dropoffs) {
    const [sx, sy] = worldToScreen(wx - 0.4, wy + 0.4);
    const [sx2, sy2] = worldToScreen(wx + 0.4, wy - 0.4);
    ctx.fillRect(sx, sy, sx2 - sx, sy2 - sy);
    ctx.strokeRect(sx, sy, sx2 - sx, sy2 - sy);
  }
}

function drawRobots(robots) {
  const dpr = devicePixelRatio;
  for (const r of robots) {
    const [sx, sy] = worldToScreen(r.x, r.y);
    const color = ROBOT_COLORS[r.id % ROBOT_COLORS.length];
    const radius = 8 * dpr;

    // Draw path to target
    if (r.target) {
      const [tx, ty] = worldToScreen(r.target[0], r.target[1]);
      ctx.strokeStyle = color + '40';
      ctx.lineWidth = 2 * dpr;
      ctx.setLineDash([6 * dpr, 4 * dpr]);
      ctx.beginPath(); ctx.moveTo(sx, sy); ctx.lineTo(tx, ty); ctx.stroke();
      ctx.setLineDash([]);
      // Target marker
      ctx.strokeStyle = color + '80';
      ctx.lineWidth = 1.5 * dpr;
      ctx.beginPath(); ctx.arc(tx, ty, 5 * dpr, 0, Math.PI * 2); ctx.stroke();
    }

    // Robot body
    ctx.fillStyle = color;
    ctx.beginPath(); ctx.arc(sx, sy, radius, 0, Math.PI * 2); ctx.fill();

    // Carrying indicator
    if (r.carrying_item) {
      ctx.fillStyle = '#ffffff';
      ctx.beginPath(); ctx.arc(sx, sy, 3 * dpr, 0, Math.PI * 2); ctx.fill();
    }

    // Robot ID
    ctx.fillStyle = '#000';
    ctx.font = `bold ${10 * dpr}px system-ui`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(r.id, sx, sy);
  }
}

function drawWalls() {
  ctx.strokeStyle = '#6366f1';
  ctx.lineWidth = 3 * devicePixelRatio;
  const [x1, y1] = worldToScreen(-10, 7);
  const [x2, y2] = worldToScreen(10, -7);
  ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
}

function render() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = '#0f1629';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  drawGrid();
  drawWalls();
  drawShelves();
  drawZones();

  if (latestState && latestState.robots) {
    drawRobots(latestState.robots);
    updateUI(latestState);
  }

  animFrame = requestAnimationFrame(render);
}

// ── UI Updates ───────────────────────────────────────────────────────
function updateUI(state) {
  const s = state.stats;
  document.getElementById('statDeliveries').textContent = s.total_deliveries;
  document.getElementById('statPending').textContent = s.pending_tasks;
  document.getElementById('statCollisions').textContent = s.collisions_avoided;
  document.getElementById('statSteps').textContent = s.total_steps;

  // Robot list
  const list = document.getElementById('robotList');
  list.innerHTML = state.robots.map(r => `
    <div class="robot-card">
      <div class="robot-dot" style="background:${ROBOT_COLORS[r.id % ROBOT_COLORS.length]}"></div>
      <span class="robot-name">Robot ${r.id}</span>
      <span class="robot-state ${r.state}">${r.state.replace(/_/g, ' ')}</span>
      <span class="robot-deliveries">${r.deliveries}</span>
    </div>
  `).join('');

  // Policy
  const grid = document.getElementById('policyGrid');
  const p = state.policy;
  grid.innerHTML = Object.entries(p).map(([k,v]) => `
    <div class="policy-item"><span class="key">${k.replace(/_/g, ' ')}:</span> <span class="val">${v}</span></div>
  `).join('');
}

// ── Chat ─────────────────────────────────────────────────────────────
const chatInput = document.getElementById('chatInput');
const chatSend = document.getElementById('chatSend');
const chatMessages = document.getElementById('chatMessages');

function addChatMessage(role, text, changes) {
  const div = document.createElement('div');
  div.className = `chat-msg ${role}`;
  let html = text;
  if (changes && Object.keys(changes).length > 0) {
    html += `<div class="changes">Changed: ${Object.entries(changes).map(([k,v]) => `${k}=${v}`).join(', ')}</div>`;
  }
  div.innerHTML = html;
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

async function sendChat() {
  const text = chatInput.value.trim();
  if (!text) return;

  const accessCode = document.getElementById('accessCode').value.trim();

  addChatMessage('user', text);
  chatInput.value = '';
  chatSend.disabled = true;

  try {
    const r = await fetch('/api/policy', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ instruction: text, access_code: accessCode || undefined }),
    });
    const data = await r.json();
    if (data.error) {
      addChatMessage('assistant', `Error: ${data.error}`);
    } else {
      addChatMessage('assistant', data.explanation, data.changes);
    }
  } catch (e) {
    addChatMessage('assistant', `Connection error: ${e.message}`);
  }
  chatSend.disabled = false;
}

chatSend.addEventListener('click', sendChat);
chatInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendChat(); });

async function addRobot() {
  try {
    const r = await fetch('/api/add-robot', { method: 'POST' });
    const data = await r.json();
    if (data.error) { alert(data.error); return; }
    addChatMessage('assistant', `Robot ${data.id} added to the fleet. Total: ${data.total_robots} robots.`);
  } catch(e) { alert('Failed to add robot: ' + e.message); }
}

// ── Init ─────────────────────────────────────────────────────────────
window.addEventListener('resize', resizeCanvas);
resizeCanvas();
connectWS();
render();

// Fallback polling
setInterval(() => {
  if (!ws || ws.readyState !== WebSocket.OPEN) pollState();
}, 500);
</script>
</body>
</html>
